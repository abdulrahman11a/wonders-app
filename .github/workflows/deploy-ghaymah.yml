name: CI/CD - Build & Deploy to Ghaymah

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout source code
      - name: Checkout source
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up .NET SDK
      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      # 3Ô∏è‚É£ Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      # 4Ô∏è‚É£ Lint (ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÉŸàÿØ)
      - name: Run Linter
        run: dotnet format --verify-no-changes || echo "::warning::Code formatting issues detected"

      # 5Ô∏è‚É£ Build
      - name: Build
        run: dotnet build --configuration Release --no-restore

      # 6Ô∏è‚É£ Unit Tests + Coverage
      - name: Run Unit Tests with Coverage
        run: |
          dotnet test --configuration Release --no-build \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            /p:CollectCoverage=true \
            /p:CoverletOutputFormat=cobertura \
            /p:CoverletOutput=./TestResults/coverage.cobertura.xml

      # 7Ô∏è‚É£ Generate HTML Coverage Report (only if coverage file exists)
      - name: Generate Coverage Report
        if: success() && hashFiles('TestResults/coverage.cobertura.xml') != ''
        run: |
          dotnet tool install --global dotnet-reportgenerator-globaltool
          export PATH="$PATH:/home/runner/.dotnet/tools"
          ~/.dotnet/tools/reportgenerator \
            -reports:"TestResults/coverage.cobertura.xml" \
            -targetdir:"TestResults/coverage-report" \
            -reporttypes:Html

      # 8Ô∏è‚É£ Upload coverage report as artifact (only if it exists)
      - name: Upload Coverage HTML Report
        if: success() && hashFiles('TestResults/coverage-report/index.html') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: TestResults/coverage-report

      # 9Ô∏è‚É£ Publish build output
      - name: Publish
        run: dotnet publish --configuration Release --output ./out --no-build

      # üîü Install Ghaymah CLI (safe version)
      - name: üå©Ô∏è Install Ghaymah CLI
        run: curl -sSl https://cli.ghaymah.systems/install.sh | bash


      # 1Ô∏è‚É£1Ô∏è‚É£ Login to Ghaymah
      - name: Login to Ghaymah
        run: gy auth login -e ${{ secrets.GY_EMAIL }} -p ${{ secrets.GY_PASSWORD }}

      # 1Ô∏è‚É£2Ô∏è‚É£ Deploy to Ghaymah
      - name: Deploy to Ghaymah
        run: gy deploy
